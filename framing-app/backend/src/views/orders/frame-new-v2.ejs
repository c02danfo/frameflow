<div class="max-w-screen-2xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">Ny Artikel</h2>
            <p class="text-sm font-medium text-slate-500">Order <%= order.order_number %></p>
        </div>
        <a href="/orders/<%= order.id %>" class="inline-flex items-center px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm font-medium rounded-lg transition-colors">
            ← Tillbaka
        </a>
    </div>

    <% if (locals.error) { %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 text-sm font-medium">
        <%= error %>
    </div>
    <% } %>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Form -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <form method="POST" action="/orders/<%= order.id %>/frames" id="frameForm" class="space-y-6">
                    
                    <!-- Template Selection -->
                    <div class="bg-sky-50 border border-sky-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <select id="templateSelect" class="flex-1 px-3 py-2 bg-white border border-sky-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <option value="">-- Välj mall (valfritt) --</option>
                                <% (templates || []).forEach(t => { %>
                                <option value="<%= t.id %>"><%= t.name %></option>
                                <% }); %>
                            </select>
                            <button type="button" id="loadTemplate" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white text-sm font-medium rounded-lg transition-colors">
                                Ladda mall
                            </button>
                        </div>
                    </div>

                    <!-- Basic Info -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="motiv" class="block text-xs font-medium text-gray-700 mb-1">Motiv</label>
                            <input type="text" id="motiv" name="motiv" placeholder="t.ex. Oljemålning" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="antal" class="block text-xs font-medium text-gray-700 mb-1">
                                Antal<span class="text-red-500 ml-1">*</span>
                            </label>
                            <input type="number" id="antal" name="antal" min="1" value="1" required class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                    </div>

                    <!-- Dimensions -->
                    <div class="border-t border-slate-200 pt-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Dimensioner</h3>
                        <div class="grid grid-cols-4 gap-3">
                            <div>
                                <label for="motiv_bredd_mm" class="block text-xs font-medium text-gray-700 mb-1">
                                    Bredd (mm)<span class="text-red-500 ml-1">*</span>
                                </label>
                                <input type="number" id="motiv_bredd_mm" name="motiv_bredd_mm" required class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="motiv_hojd_mm" class="block text-xs font-medium text-gray-700 mb-1">
                                    Höjd (mm)<span class="text-red-500 ml-1">*</span>
                                </label>
                                <input type="number" id="motiv_hojd_mm" name="motiv_hojd_mm" required class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="calculation_method" class="block text-xs font-medium text-gray-700 mb-1">Metod</label>
                                <select id="calculation_method" name="calculation_method" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                                    <option value="simple">Enkel</option>
                                    <option value="standard">Standard</option>
                                </select>
                            </div>
                            <div id="simple_price_container">
                                <label for="simple_price_per_meter" class="block text-xs font-medium text-gray-700 mb-1">Pris/m</label>
                                <input type="number" id="simple_price_per_meter" name="simple_price_per_meter" step="0.01" value="250" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                        </div>
                        
                        <!-- PP Edges (collapsible) -->
                        <div class="mt-3">
                            <button type="button" id="togglePP" class="text-xs text-sky-600 hover:text-sky-700 font-medium">
                                ▸ Passepartout-kanter
                            </button>
                            <div id="ppEdges" class="hidden grid grid-cols-4 gap-2 mt-2">
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-600 mb-1">Vänster</label>
                                    <input type="number" id="pp_vanster_mm" value="0" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-600 mb-1">Höger</label>
                                    <input type="number" id="pp_hoger_mm" value="0" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-600 mb-1">Topp</label>
                                    <input type="number" id="pp_topp_mm" value="0" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-600 mb-1">Botten</label>
                                    <input type="number" id="pp_botten_mm" value="0" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items List -->
                    <div class="border-t border-slate-200 pt-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Artiklar & Tjänster</h3>
                            <div class="flex gap-2">
                                <button type="button" id="addArticleBtn" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium rounded transition-colors">
                                    + Artikel
                                </button>
                                <button type="button" id="addServiceBtn" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium rounded transition-colors">
                                    + Tjänst
                                </button>
                            </div>
                        </div>
                        
                        <!-- Items Container -->
                        <div id="itemsContainer" class="space-y-2"></div>
                        
                        <!-- Hidden items data for form submission -->
                        <input type="hidden" name="items" id="itemsData" />
                    </div>

                    <!-- Notes -->
                    <div class="border-t border-slate-200 pt-4">
                        <label for="notes" class="block text-xs font-medium text-gray-700 mb-1">Anteckningar</label>
                        <textarea id="notes" name="notes" rows="2" placeholder="Valfria noteringar" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 resize-y"></textarea>
                    </div>

                    <!-- Save as Template -->
                    <div class="border-t border-slate-200 pt-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="saveAsTemplate" class="rounded border-gray-300 text-sky-600 focus:ring-sky-500">
                            <span class="text-xs font-medium text-gray-700">Spara som mall</span>
                        </label>
                        <div id="templateNameContainer" class="hidden mt-2">
                            <input type="text" id="templateName" placeholder="Mallnamn" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
                        <a href="/orders/<%= order.id %>" class="px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm font-medium rounded-lg transition-colors">
                            Avbryt
                        </a>
                        <button type="submit" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
                            Spara artikel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Price Preview -->
        <div class="lg:col-span-1">
            <div class="sticky top-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Prisberäkning</h3>
                    <div id="sizePreview" class="flex flex-wrap gap-1.5 mb-4"></div>
                    <div id="pricePreview" class="space-y-2">
                        <p class="text-xs text-slate-400 italic">Fyll i artiklar för att se pris...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Data storage
let items = [];
let itemIdCounter = 0;

// Available items data
const availableItems = {
    frame: <%= JSON.stringify(frames || []) %>,
    glass: <%= JSON.stringify(glasses || []) %>,
    passepartout: <%= JSON.stringify(passepartouts || []) %>,
    labor: <%= JSON.stringify(labors || []) %>
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    updateMethodVisibility();
});

function setupEventListeners() {
    document.getElementById('calculation_method').addEventListener('change', updateMethodVisibility);
    document.getElementById('addArticleBtn').addEventListener('click', () => addItem('article'));
    document.getElementById('addServiceBtn').addEventListener('click', () => addItem('service'));
    document.getElementById('saveAsTemplate').addEventListener('change', toggleTemplateNameInput);
    document.getElementById('togglePP').addEventListener('click', togglePPEdges);
    document.getElementById('loadTemplate').addEventListener('click', loadTemplate);
    
    // Trigger calculation on dimension changes
    ['motiv_bredd_mm', 'motiv_hojd_mm', 'pp_vanster_mm', 'pp_hoger_mm', 'pp_topp_mm', 'pp_botten_mm', 
     'antal', 'calculation_method', 'simple_price_per_meter'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', calculatePrice);
            el.addEventListener('change', calculatePrice);
        }
    });
    
    document.getElementById('frameForm').addEventListener('submit', handleSubmit);
}

function updateMethodVisibility() {
    const method = document.getElementById('calculation_method').value;
    document.getElementById('simple_price_container').style.display = method === 'simple' ? 'block' : 'none';
}

function togglePPEdges() {
    const container = document.getElementById('ppEdges');
    const btn = document.getElementById('togglePP');
    const isHidden = container.classList.contains('hidden');
    container.classList.toggle('hidden');
    btn.textContent = isHidden ? '▾ Passepartout-kanter' : '▸ Passepartout-kanter';
}

function toggleTemplateNameInput() {
    const checked = document.getElementById('saveAsTemplate').checked;
    document.getElementById('templateNameContainer').classList.toggle('hidden', !checked);
}

function addItem(category) {
    const itemId = itemIdCounter++;
    const item = {
        id: itemId,
        category: category, // 'article' or 'service'
        type: category === 'article' ? 'frame' : 'labor',
        item_id: null,
        quantity: 1,
        unit_price: 0,
        metadata: {}
    };
    
    items.push(item);
    renderItems();
    calculatePrice();
}

function removeItem(itemId) {
    items = items.filter(item => item.id !== itemId);
    renderItems();
    calculatePrice();
}

function updateItem(itemId, field, value) {
    const item = items.find(i => i.id === itemId);
    if (item) {
        if (field === 'item_id') {
            // Update item details from selected inventory item
            const itemData = findItemData(item.type, value);
            if (itemData) {
                item.item_id = itemData.id;
                item.item_name = itemData.name;
                item.item_sku = itemData.sku;
                item.unit_price = parseFloat(itemData.sales_price) || 0;
            }
        } else if (field === 'type') {
            item.type = value;
            item.item_id = null;
            item.unit_price = 0;
        } else if (field === 'metadata') {
            item.metadata = { ...item.metadata, ...value };
        } else {
            item[field] = value;
        }
        renderItems();
        calculatePrice();
    }
}

function findItemData(type, itemId) {
    const itemList = availableItems[type] || [];
    return itemList.find(i => i.id == itemId);
}

function renderItems() {
    const container = document.getElementById('itemsContainer');
    
    if (items.length === 0) {
        container.innerHTML = '<p class="text-xs text-slate-400 italic py-3 text-center">Inga artiklar tillagda ännu. Klicka "+ Artikel" eller "+ Tjänst" ovan.</p>';
        return;
    }
    
    container.innerHTML = items.map(item => {
        const isService = item.category === 'service';
        const typeOptions = isService 
            ? '<option value="labor">Arbete/Tjänst</option>'
            : `<option value="frame">Ram</option>
               <option value="glass">Glas</option>
               <option value="passepartout">Passepartout</option>`;
        
        const itemOptions = (availableItems[item.type] || []).map(i => 
            `<option value="${i.id}" ${item.item_id == i.id ? 'selected' : ''}>${i.name} (${i.sku}) - ${i.sales_price} kr</option>`
        ).join('');
        
        const unitLabel = item.type === 'glass' || item.type === 'passepartout' ? 'm²' : 
                          item.type === 'labor' ? (isService ? 'tim' : 'm') : 'm';
        
        return `
            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg border border-slate-200">
                <select onchange="updateItem(${item.id}, 'type', this.value)" class="w-32 px-2 py-1 border border-gray-300 rounded text-xs bg-white focus:outline-none focus:ring-1 focus:ring-sky-500">
                    ${typeOptions}
                    <option value="${item.type}" selected hidden>${item.type}</option>
                </select>
                
                <select onchange="updateItem(${item.id}, 'item_id', this.value)" class="flex-1 px-2 py-1 border border-gray-300 rounded text-xs bg-white focus:outline-none focus:ring-1 focus:ring-sky-500">
                    <option value="">-- Välj ${item.type} --</option>
                    ${itemOptions}
                </select>
                
                <div class="flex items-center gap-1">
                    <input type="number" step="0.01" value="${item.quantity}" onchange="updateItem(${item.id}, 'quantity', this.value)" 
                           class="w-16 px-2 py-1 border border-gray-300 rounded text-xs text-right focus:outline-none focus:ring-1 focus:ring-sky-500" />
                    <span class="text-[10px] text-slate-500 w-6">${unitLabel}</span>
                </div>
                
                <div class="flex items-center gap-1">
                    <span class="text-[10px] text-slate-500">à</span>
                    <input type="number" step="0.01" value="${item.unit_price}" onchange="updateItem(${item.id}, 'unit_price', this.value)" 
                           class="w-16 px-2 py-1 border border-gray-300 rounded text-xs text-right focus:outline-none focus:ring-1 focus:ring-sky-500" />
                    <span class="text-[10px] text-slate-500">kr</span>
                </div>
                
                <div class="text-xs font-bold text-slate-700 w-16 text-right">
                    ${((item.quantity || 0) * (item.unit_price || 0)).toFixed(2)} kr
                </div>
                
                <button type="button" onclick="removeItem(${item.id})" class="p-1 text-red-500 hover:bg-red-50 rounded transition-colors" title="Ta bort">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        `;
    }).join('');
}

async function calculatePrice() {
    const mwMm = parseFloat(document.getElementById('motiv_bredd_mm').value) || 0;
    const mhMm = parseFloat(document.getElementById('motiv_hojd_mm').value) || 0;
    
    if (!mwMm || !mhMm || items.length === 0) {
        document.getElementById('pricePreview').innerHTML = '<p class="text-xs text-slate-400 italic">Fyll i mått och artiklar</p>';
        return;
    }
    
    const plMm = parseFloat(document.getElementById('pp_vanster_mm').value) || 0;
    const prMm = parseFloat(document.getElementById('pp_hoger_mm').value) || 0;
    const ptMm = parseFloat(document.getElementById('pp_topp_mm').value) || 0;
    const pbMm = parseFloat(document.getElementById('pp_botten_mm').value) || 0;
    const quantity = parseInt(document.getElementById('antal').value) || 1;
    const outerWmm = mwMm + plMm + prMm;
    const outerHmm = mhMm + ptMm + pbMm;
    const outerArea = (outerWmm / 1000) * (outerHmm / 1000);
    const perimeter = (2 * outerWmm + 2 * outerHmm) / 1000;
    
    // Display size info
    document.getElementById('sizePreview').innerHTML = `
        <span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold text-slate-600">Omkrets: ${perimeter.toFixed(2)}m</span>
        <span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold text-slate-600">Area: ${outerArea.toFixed(4)}m²</span>
        <span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold text-slate-600">Antal: ${quantity}st</span>
    `;
    
    // Calculate total
    let totalExclMoms = 0;
    let html = '<div class="space-y-1.5">';
    
    items.forEach(item => {
        let itemQuantity = parseFloat(item.quantity) || 0;
        
        // Calculate based on type
        if (item.type === 'frame' || item.type === 'labor') {
            itemQuantity = perimeter;
        } else if (item.type === 'glass' || item.type === 'passepartout') {
            itemQuantity = outerArea;
        }
        
        const cost = itemQuantity * (parseFloat(item.unit_price) || 0);
        totalExclMoms += cost;
        
        if (cost > 0) {
            html += `
                <div class="flex justify-between items-center py-1 border-b border-slate-100 text-xs">
                    <div>
                        <p class="text-slate-400 font-bold text-[10px] uppercase">${item.type}</p>
                        <p class="text-slate-600">${item.item_name || 'Ej vald'}</p>
                    </div>
                    <span class="text-slate-900 font-bold">${cost.toFixed(2)} kr</span>
                </div>
            `;
        }
    });
    
    const totalInclMoms = totalExclMoms * 1.25;
    
    html += `
        <div class="pt-3 space-y-1.5 mt-2">
            <div class="flex justify-between items-center text-xs">
                <span class="text-slate-500 font-medium">Exkl. moms</span>
                <span class="text-slate-900 font-bold">${totalExclMoms.toFixed(2)} kr</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-emerald-50 rounded-lg border border-emerald-100">
                <span class="text-xs font-bold text-emerald-700">Inkl. moms</span>
                <span class="text-lg font-extrabold text-emerald-700">${totalInclMoms.toFixed(2)} kr</span>
            </div>
        </div>
    `;
    html += '</div>';
    
    document.getElementById('pricePreview').innerHTML = html;
}

function handleSubmit(e) {
    e.preventDefault();
    
    // Prepare items data
    const itemsData = items.map(item => ({
        type: item.type,
        item_id: item.item_id,
        item_name: item.item_name,
        item_sku: item.item_sku,
        quantity: item.quantity,
        unit_price: item.unit_price,
        metadata: item.metadata
    }));
    
    document.getElementById('itemsData').value = JSON.stringify(itemsData);
    
    // Submit form
    e.target.submit();
}

async function loadTemplate() {
    const templateId = document.getElementById('templateSelect').value;
    if (!templateId) {
        alert('Välj en mall först');
        return;
    }
    
    try {
        const response = await fetch(`/templates/${templateId}`);
        const template = await response.json();
        
        // Load template items
        items = (template.items || []).map((item, index) => ({
            id: itemIdCounter++,
            category: item.type === 'labor' ? 'service' : 'article',
            ...item
        }));
        
        // Load default PP edges if available
        if (template.default_passepartout_edges) {
            document.getElementById('pp_vanster_mm').value = template.default_passepartout_edges.left || 0;
            document.getElementById('pp_hoger_mm').value = template.default_passepartout_edges.right || 0;
            document.getElementById('pp_topp_mm').value = template.default_passepartout_edges.top || 0;
            document.getElementById('pp_botten_mm').value = template.default_passepartout_edges.bottom || 0;
        }
        
        renderItems();
        calculatePrice();
    } catch (error) {
        console.error('Failed to load template:', error);
        alert('Kunde inte ladda mall');
    }
}
</script>
