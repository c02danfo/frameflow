<div class="max-w-screen-2xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight"><%= locals.isEdit ? 'Redigera Artikel' : 'Ny Artikel' %></h2>
            <p class="text-sm font-medium text-slate-500">Order <%= order.order_number %></p>
        </div>
        <a href="/orders/<%= order.id %>" class="inline-flex items-center px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm font-medium rounded-lg transition-colors">
            ‚Üê Tillbaka
        </a>
    </div>

    <% if (locals.error) { %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 text-sm font-medium">
        <%= error %>
    </div>
    <% } %>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Form -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <form method="POST" action="<%= locals.isEdit ? `/orders/${order.id}/frames/${frame.id}/edit` : `/orders/${order.id}/frames` %>" id="frameForm" class="space-y-6" enctype="multipart/form-data">
                    
                    <!-- Basic Info -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="motiv" class="block text-xs font-medium text-gray-700 mb-1">Motiv</label>
                            <input type="text" id="motiv" name="motiv" value="<%= locals.frame ? frame.motiv || '' : '' %>" placeholder="t.ex. Oljem√•lning" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="antal" class="block text-xs font-medium text-gray-700 mb-1">
                                Antal<span class="text-red-500 ml-1">*</span>
                            </label>
                            <input type="number" id="antal" name="antal" min="1" value="<%= locals.frame ? frame.antal || 1 : 1 %>" required class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                    </div>

                    <!-- Dimensions -->
                    <div class="border-t border-slate-200 pt-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Dimensioner</h3>
                        <div class="grid grid-cols-4 gap-3">
                            <div>
                                <label for="motiv_bredd_mm" class="block text-xs font-medium text-gray-700 mb-1">
                                    Bredd (mm)<span class="text-red-500 ml-1">*</span>
                                </label>
                                <input type="number" id="motiv_bredd_mm" name="motiv_bredd_mm" value="<%= locals.frame ? frame.motiv_width_mm || '' : '' %>" required class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="motiv_hojd_mm" class="block text-xs font-medium text-gray-700 mb-1">
                                    H√∂jd (mm)<span class="text-red-500 ml-1">*</span>
                                </label>
                                <input type="number" id="motiv_hojd_mm" name="motiv_hojd_mm" value="<%= locals.frame ? frame.motiv_height_mm || '' : '' %>" required class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="calculation_method" class="block text-xs font-medium text-gray-700 mb-1">Metod</label>
                                <select id="calculation_method" name="calculation_method" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                                    <option value="simple" <%= locals.frame && frame.calculation_method === 'simple' ? 'selected' : '' %>>Enkel</option>
                                    <option value="standard" <%= locals.frame && frame.calculation_method === 'standard' ? 'selected' : '' %>>Standard</option>
                                </select>
                            </div>
                            <div id="simple_price_container">
                                <label for="simple_price_per_meter" class="block text-xs font-medium text-gray-700 mb-1">Pris/m</label>
                                <input type="number" id="simple_price_per_meter" name="simple_price_per_meter" step="0.01" value="<%= locals.frame ? frame.manual_simple_price_per_meter || 250 : 250 %>" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                        </div>
                        
                        <!-- PP Edges (collapsible) -->
                        <div class="mt-3">
                            <button type="button" id="togglePP" class="text-xs text-sky-600 hover:text-sky-700 font-medium">
                                ‚ñ∏ Passepartout-kanter
                            </button>
                            <div id="ppEdges" class="hidden grid grid-cols-4 gap-2 mt-2">
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-600 mb-1">V√§nster</label>
                                    <input type="number" id="pp_vanster_mm" value="<%= locals.frame ? frame.pp_left_mm || 0 : 0 %>" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-600 mb-1">H√∂ger</label>
                                    <input type="number" id="pp_hoger_mm" value="<%= locals.frame ? frame.pp_right_mm || 0 : 0 %>" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-600 mb-1">Topp</label>
                                    <input type="number" id="pp_topp_mm" value="<%= locals.frame ? frame.pp_top_mm || 0 : 0 %>" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-600 mb-1">Botten</label>
                                    <input type="number" id="pp_botten_mm" value="<%= locals.frame ? frame.pp_bottom_mm || 0 : 0 %>" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items List -->
                    <div class="border-t border-slate-200 pt-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Material & Tj√§nster</h3>
                            <div class="flex gap-2">
                                <select id="templateSelect" class="px-2 py-1 bg-white border border-gray-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-500">
                                    <option value="">V√§lj mall...</option>
                                    <% (templates || []).forEach(t => { %>
                                    <option value="<%= t.id %>"><%= t.name %></option>
                                    <% }); %>
                                </select>
                                <button type="button" id="loadTemplate" class="px-3 py-1 bg-sky-600 hover:bg-sky-700 text-white text-xs font-medium rounded transition-colors">
                                    Ladda
                                </button>
                                <button type="button" id="addArticleBtn" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium rounded transition-colors">
                                    + Material
                                </button>
                                <button type="button" id="addServiceBtn" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium rounded transition-colors">
                                    + Tj√§nst
                                </button>
                            </div>
                        </div>
                        
                        <!-- Items Container -->
                        <div id="itemsContainer" class="space-y-2"></div>
                        
                        <!-- Hidden items data for form submission -->
                        <input type="hidden" name="itemsData" id="itemsData" />
                    </div>

                    <!-- Notes -->
                    <div class="border-t border-slate-200 pt-4">
                        <label for="notes" class="block text-xs font-medium text-gray-700 mb-1">Anteckningar</label>
                        <textarea id="notes" name="notes" rows="2" placeholder="Valfria noteringar" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 resize-y"><%= locals.frame ? frame.notes || '' : '' %></textarea>
                    </div>

                    <!-- Save as Template -->
                    <div class="border-t border-slate-200 pt-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="saveAsTemplate" class="rounded border-gray-300 text-sky-600 focus:ring-sky-500">
                            <span class="text-xs font-medium text-gray-700">Spara som mall</span>
                        </label>
                        <div id="templateNameContainer" class="hidden mt-2">
                            <input type="text" id="templateName" placeholder="Mallnamn" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                    </div>

                    <!-- Photo Documentation -->
                    <div class="border-t border-slate-200 pt-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Fotodokumentation</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Before Photos -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">F√∂re-bilder (max 3)</label>
                                <input type="file" id="beforeImages" accept="image/*" capture="environment" multiple class="hidden">
                                <button type="button" onclick="document.getElementById('beforeImages').click()" class="inline-flex items-center px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 text-xs font-medium rounded-lg transition-colors w-full justify-center">
                                    üì∑ L√§gg till f√∂re-bilder
                                </button>
                                <div id="beforePreview" class="grid grid-cols-3 gap-2 mt-2"></div>
                            </div>
                            
                            <!-- After Photos -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">Efter-bilder (max 3)</label>
                                <input type="file" id="afterImages" accept="image/*" capture="environment" multiple class="hidden">
                                <button type="button" onclick="document.getElementById('afterImages').click()" class="inline-flex items-center px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 text-xs font-medium rounded-lg transition-colors w-full justify-center">
                                    üì∑ L√§gg till efter-bilder
                                </button>
                                <div id="afterPreview" class="grid grid-cols-3 gap-2 mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
                        <a href="/orders/<%= order.id %>" class="px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-sm font-medium rounded-lg transition-colors">
                            Avbryt
                        </a>
                        <button type="submit" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
                            <%= locals.isEdit ? 'Uppdatera artikel' : 'Spara artikel' %>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Price Preview -->
        <div class="lg:col-span-1">
            <div class="sticky top-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Prisber√§kning</h3>
                    <div id="sizePreview" class="flex flex-wrap gap-1.5 mb-4"></div>
                    <div id="pricePreview" class="space-y-2">
                        <p class="text-xs text-slate-400 italic">Fyll i artiklar f√∂r att se pris...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Data storage
let items = [];
let itemIdCounter = 0;
let beforePhotos = [];
let afterPhotos = [];

// Available items data
const availableItems = {
    // IMPORTANT: use unescaped EJS output so JSON isn't HTML-entity-escaped (e.g. &quot;),
    // which would break JavaScript parsing with "Unexpected token '&'".
    frame: <%- JSON.stringify(frames || []) %>,
    glass: <%- JSON.stringify(glasses || []) %>,
    passepartout: <%- JSON.stringify(passepartouts || []) %>,
    // 'labor' type in UI maps to services table data
    labor: <%- JSON.stringify(services || []) %>
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    updateMethodVisibility();
    
    // Load existing items if in edit mode
    <% if (locals.isEdit && locals.frame) { %>
    loadExistingItems();
    <% } %>
});

function loadExistingItems() {
    // Build items array from frame_order_items data
    const frameItems = <%- JSON.stringify(locals.frameItems || []) %>;
    
    console.log('Loading existing items:', frameItems);
    
    // Add each item from database
    frameItems.forEach(dbItem => {
        items.push({
            id: itemIdCounter++,
            category: dbItem.item_type === 'labor' ? 'service' : 'article',
            type: dbItem.item_type,
            item_id: dbItem.item_id,
            item_name: dbItem.item_name,
            item_sku: dbItem.item_sku,
            quantity: parseFloat(dbItem.quantity) || 0,
            unit_price: parseFloat(dbItem.unit_price) || 0,
            metadata: typeof dbItem.metadata === 'string' ? JSON.parse(dbItem.metadata) : (dbItem.metadata || {})
        });
    });
    
    renderItems();
    calculatePrice();
    
    // Expand PP edges if there are non-zero PP values
    const frame = <%- JSON.stringify(locals.frame || {}) %>;
    if (frame.pp_left_mm || frame.pp_right_mm || frame.pp_top_mm || frame.pp_bottom_mm) {
        const ppContainer = document.getElementById('ppEdges');
        const ppBtn = document.getElementById('togglePP');
        ppContainer.classList.remove('hidden');
        ppBtn.textContent = '‚ñæ Passepartout-kanter';
    }
}

function setupEventListeners() {
    document.getElementById('calculation_method').addEventListener('change', updateMethodVisibility);
    document.getElementById('addArticleBtn').addEventListener('click', () => addItem('article'));
    document.getElementById('addServiceBtn').addEventListener('click', () => addItem('service'));
    document.getElementById('saveAsTemplate').addEventListener('change', toggleTemplateNameInput);
    document.getElementById('togglePP').addEventListener('click', togglePPEdges);
    document.getElementById('loadTemplate').addEventListener('click', loadTemplate);
    
    // Photo upload listeners
    document.getElementById('beforeImages').addEventListener('change', (e) => handlePhotoSelection(e, 'before'));
    document.getElementById('afterImages').addEventListener('change', (e) => handlePhotoSelection(e, 'after'));
    
    // Trigger calculation on dimension changes
    ['motiv_bredd_mm', 'motiv_hojd_mm', 'pp_vanster_mm', 'pp_hoger_mm', 'pp_topp_mm', 'pp_botten_mm', 
     'antal', 'calculation_method', 'simple_price_per_meter'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', calculatePrice);
            el.addEventListener('change', calculatePrice);
        }
    });
    
    document.getElementById('frameForm').addEventListener('submit', handleSubmit);
}

function updateMethodVisibility() {
    const method = document.getElementById('calculation_method').value;
    document.getElementById('simple_price_container').style.display = method === 'simple' ? 'block' : 'none';
}

function togglePPEdges() {
    const container = document.getElementById('ppEdges');
    const btn = document.getElementById('togglePP');
    const isHidden = container.classList.contains('hidden');
    container.classList.toggle('hidden');
    btn.textContent = isHidden ? '‚ñæ Passepartout-kanter' : '‚ñ∏ Passepartout-kanter';
}

function toggleTemplateNameInput() {
    const checked = document.getElementById('saveAsTemplate').checked;
    document.getElementById('templateNameContainer').classList.toggle('hidden', !checked);
}

function handlePhotoSelection(event, category) {
    const files = Array.from(event.target.files);
    const photoArray = category === 'before' ? beforePhotos : afterPhotos;
    const maxPhotos = 3;
    
    // Check total count
    const remainingSlots = maxPhotos - photoArray.length;
    if (files.length > remainingSlots) {
        alert(`Du kan bara l√§gga till ${remainingSlots} fler bild(er). Max ${maxPhotos} bilder per kategori.`);
        event.target.value = '';
        return;
    }
    
    // Add new photos
    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            photoArray.push(file);
        }
    });
    
    // Update array reference
    if (category === 'before') {
        beforePhotos = photoArray;
    } else {
        afterPhotos = photoArray;
    }
    
    renderPhotoPreview(category);
    event.target.value = ''; // Reset input
}

function renderPhotoPreview(category) {
    const photoArray = category === 'before' ? beforePhotos : afterPhotos;
    const containerId = category === 'before' ? 'beforePreview' : 'afterPreview';
    const container = document.getElementById(containerId);
    
    container.innerHTML = photoArray.map((file, index) => `
        <div class="relative aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
            <img src="${URL.createObjectURL(file)}" class="w-full h-full object-cover" alt="${category} ${index + 1}">
            <button type="button" onclick="removePhoto('${category}', ${index})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs font-bold transition-colors">
                √ó
            </button>
            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-[10px] text-center py-0.5">
                ${(file.size / 1024).toFixed(0)} KB
            </div>
        </div>
    `).join('');
}

function removePhoto(category, index) {
    if (category === 'before') {
        beforePhotos.splice(index, 1);
    } else {
        afterPhotos.splice(index, 1);
    }
    renderPhotoPreview(category);
}

function addItem(category) {
    const itemId = itemIdCounter++;
    const item = {
        id: itemId,
        category: category, // 'article' or 'service'
        type: category === 'article' ? 'frame' : 'labor',
        item_id: null,
        quantity: 1,
        unit_price: 0,
        metadata: {}
    };
    
    items.push(item);
    renderItems();
    calculatePrice();
}

function removeItem(itemId) {
    items = items.filter(item => item.id !== itemId);
    renderItems();
    calculatePrice();
}

function updateItem(itemId, field, value) {
    const item = items.find(i => i.id === itemId);
    if (item) {
        if (field === 'item_id') {
            // Update item details from selected inventory item
            const itemData = findItemData(item.type, value);
            if (itemData) {
                item.item_id = itemData.id;
                item.item_name = itemData.name;
                item.item_sku = itemData.sku;
                item.unit_price = parseFloat(itemData.sales_price) || 0;
                
                // If this is a service (labor), copy standard_hours to quantity
                if (item.type === 'labor' && itemData.standard_hours) {
                    item.quantity = parseFloat(itemData.standard_hours);
                }
            }
        } else if (field === 'type') {
            item.type = value;
            item.item_id = null;
            item.unit_price = 0;
        } else if (field === 'metadata') {
            item.metadata = { ...item.metadata, ...value };
        } else {
            item[field] = value;
        }
        renderItems();
        calculatePrice();
    }
}

function findItemData(type, itemId) {
    const itemList = availableItems[type] || [];
    return itemList.find(i => i.id == itemId);
}

function renderItems() {
    const container = document.getElementById('itemsContainer');
    
    if (items.length === 0) {
        container.innerHTML = '<p class="text-xs text-slate-400 italic py-3 text-center">Inga artiklar tillagda √§nnu. Klicka "+ Artikel" eller "+ Tj√§nst" ovan.</p>';
        return;
    }
    
    container.innerHTML = items.map(item => {
        const isService = item.category === 'service';
        
        // Build type options with correct selected state
        let typeOptionsHtml = '';
        if (isService) {
            typeOptionsHtml = `<option value="labor" ${item.type === 'labor' ? 'selected' : ''}>Arbete/Tj√§nst</option>`;
        } else {
            typeOptionsHtml = `
                <option value="frame" ${item.type === 'frame' ? 'selected' : ''}>Ram</option>
                <option value="glass" ${item.type === 'glass' ? 'selected' : ''}>Glas</option>
                <option value="passepartout" ${item.type === 'passepartout' ? 'selected' : ''}>Passepartout</option>
            `;
        }
        
        const itemOptions = (availableItems[item.type] || []).map(i => 
            `<option value="${i.id}" ${item.item_id == i.id ? 'selected' : ''}>${i.name} (${i.sku}) - ${i.sales_price} kr</option>`
        ).join('');
        
        const unitLabel = item.type === 'glass' || item.type === 'passepartout' ? 'm\u00B2' : 
                          item.type === 'labor' ? (isService ? 'tim' : 'm') : 'm';
        
        return `
            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg border border-slate-200">
                <select onchange="updateItem(${item.id}, 'type', this.value)" class="w-32 px-2 py-1 border border-gray-300 rounded text-xs bg-white focus:outline-none focus:ring-1 focus:ring-sky-500">
                    ${typeOptionsHtml}
                </select>
                
                <select onchange="updateItem(${item.id}, 'item_id', this.value)" class="flex-1 px-2 py-1 border border-gray-300 rounded text-xs bg-white focus:outline-none focus:ring-1 focus:ring-sky-500">
                    <option value="">-- V√§lj ${item.type} --</option>
                    ${itemOptions}
                </select>
                
                <div class="flex items-center gap-1">
                    <input type="number" step="0.01" value="${item.quantity}" onchange="updateItem(${item.id}, 'quantity', this.value)" 
                           class="w-16 px-2 py-1 border border-gray-300 rounded text-xs text-right focus:outline-none focus:ring-1 focus:ring-sky-500" />
                    <span class="text-[10px] text-slate-500 w-6">${unitLabel}</span>
                </div>
                
                <div class="flex items-center gap-1">
                    <span class="text-[10px] text-slate-500">√†</span>
                    <input type="number" step="0.01" value="${item.unit_price}" onchange="updateItem(${item.id}, 'unit_price', this.value)" 
                           class="w-16 px-2 py-1 border border-gray-300 rounded text-xs text-right focus:outline-none focus:ring-1 focus:ring-sky-500" />
                    <span class="text-[10px] text-slate-500">kr</span>
                </div>
                
                <div class="text-xs font-bold text-slate-700 w-16 text-right">
                    ${((item.quantity || 0) * (item.unit_price || 0)).toFixed(2)} kr
                </div>
                
                <button type="button" onclick="removeItem(${item.id})" class="p-1 text-red-500 hover:bg-red-50 rounded transition-colors" title="Ta bort">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        `;
    }).join('');
}

function calculatePrice() {
    const mwMm = parseFloat(document.getElementById('motiv_bredd_mm').value) || 0;
    const mhMm = parseFloat(document.getElementById('motiv_hojd_mm').value) || 0;
    
    if (!mwMm || !mhMm) {
        document.getElementById('pricePreview').innerHTML = '<p class="text-xs text-slate-400 italic">Fyll i motiv-bredd och h√∂jd</p>';
        return;
    }
    
    const plMm = parseFloat(document.getElementById('pp_vanster_mm').value) || 0;
    const prMm = parseFloat(document.getElementById('pp_hoger_mm').value) || 0;
    const ptMm = parseFloat(document.getElementById('pp_topp_mm').value) || 0;
    const pbMm = parseFloat(document.getElementById('pp_botten_mm').value) || 0;
    const quantity = parseInt(document.getElementById('antal').value) || 1;
    const outerWmm = mwMm + plMm + prMm;
    const outerHmm = mhMm + ptMm + pbMm;
    const outerArea = (outerWmm / 1000) * (outerHmm / 1000);
    const perimeter = (2 * outerWmm + 2 * outerHmm) / 1000;
    
    // Display size info
    document.getElementById('sizePreview').innerHTML = `
        <span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold text-slate-600">Omkrets: ${perimeter.toFixed(2)}m</span>
        <span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold text-slate-600">Area: ${outerArea.toFixed(4)}m¬≤</span>
        <span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold text-slate-600">Antal: ${quantity}st</span>
    `;
    
    // Determine calculation method
    const method = document.getElementById('calculation_method').value;
    let totalExclMoms = 0;
    let html = '<div class="space-y-1.5">';
    
    if (method === 'simple') {
        // ENKEL METOD: Omkrets * pris/m * antal
        const pricePerMeterInput = document.getElementById('simple_price_per_meter');
        const pricePerMeter = parseFloat(pricePerMeterInput ? pricePerMeterInput.value : 0) || 0;
        
        if (pricePerMeter > 0) {
            totalExclMoms = perimeter * pricePerMeter * quantity;
            
            html += `
                <div class="flex justify-between items-center py-1 border-b border-slate-100 text-xs">
                    <div>
                        <p class="text-slate-400 font-bold text-[10px] uppercase">Ram (Enkel)</p>
                        <p class="text-slate-600">${perimeter.toFixed(2)}m √ó ${pricePerMeter} kr/m √ó ${quantity}st</p>
                    </div>
                    <span class="text-slate-900 font-bold">${totalExclMoms.toFixed(2)} kr</span>
                </div>
            `;
        } else {
            html += `
                <div class="flex justify-between items-center py-1 border-b border-slate-100 text-xs">
                    <div>
                        <p class="text-slate-400 font-bold text-[10px] uppercase">Ram (Enkel)</p>
                        <p class="text-slate-600">Ange pris/m f√∂r ber√§kning</p>
                    </div>
                    <span class="text-slate-900 font-bold">0.00 kr</span>
                </div>
            `;
        }
    } else {
        // STANDARD METOD: Ber√§kna fr√•n Material & Tj√§nster lista
        if (items.length === 0) {
            document.getElementById('pricePreview').innerHTML = '<p class="text-xs text-slate-400 italic">L√§gg till material eller tj√§nster f√∂r att ber√§kna pris</p>';
            return;
        }
        
        items.forEach(item => {
            let itemQuantity = parseFloat(item.quantity) || 0;
            
            // Auto-ber√§kna kvantitet baserat p√• typ
            if (item.type === 'frame') {
                itemQuantity = perimeter * quantity;
            } else if (item.type === 'glass' || item.type === 'passepartout') {
                itemQuantity = outerArea * quantity;
            }
            // F√∂r labor/tj√§nst: anv√§nd manuell quantity
            
            const cost = itemQuantity * (parseFloat(item.unit_price) || 0);
            totalExclMoms += cost;
            
            if (cost > 0 || itemQuantity > 0) {
                const unitLabel = item.type === 'glass' || item.type === 'passepartout' ? 'm¬≤' : 
                                  item.type === 'labor' ? 'tim' : 'm';
                
                html += `
                    <div class="flex justify-between items-center py-1 border-b border-slate-100 text-xs">
                        <div>
                            <p class="text-slate-400 font-bold text-[10px] uppercase">${item.type}</p>
                            <p class="text-slate-600">${item.item_name || 'Ej vald'} (${itemQuantity.toFixed(2)}${unitLabel})</p>
                        </div>
                        <span class="text-slate-900 font-bold">${cost.toFixed(2)} kr</span>
                    </div>
                `;
            }
        });
        
        if (totalExclMoms === 0) {
            html += `
                <div class="text-xs text-slate-400 italic py-2">
                    Ingen kostnad ber√§knad. L√§gg till material/tj√§nster med pris.
                </div>
            `;
        }
    }
    
    const totalInclMoms = totalExclMoms * 1.25;
    
    html += `
        <div class="pt-3 space-y-1.5 mt-2">
            <div class="flex justify-between items-center text-xs">
                <span class="text-slate-500 font-medium">Exkl. moms</span>
                <span class="text-slate-900 font-bold">${totalExclMoms.toFixed(2)} kr</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-emerald-50 rounded-lg border border-emerald-100">
                <span class="text-xs font-bold text-emerald-700">Inkl. moms (25%)</span>
                <span class="text-lg font-extrabold text-emerald-700">${totalInclMoms.toFixed(2)} kr</span>
            </div>
        </div>
    `;
    html += '</div>';
    
    document.getElementById('pricePreview').innerHTML = html;
}

function handleSubmit(e) {
    e.preventDefault();
    
    console.log('handleSubmit called!');
    console.log('Items to save:', items);
    
    // Validate required fields
    const motivBredd = document.getElementById('motiv_bredd_mm').value;
    const motivHojd = document.getElementById('motiv_hojd_mm').value;
    const antal = document.getElementById('antal').value;
    
    if (!motivBredd || !motivHojd || !antal) {
        alert('Fyll i alla obligatoriska f√§lt (m√§rkta med *).');
        return;
    }
    
    // Create FormData with all form fields
    const formData = new FormData();
    
    // Add all input fields from the form
    formData.append('motiv', document.getElementById('motiv').value || '');
    formData.append('antal', document.getElementById('antal').value);
    formData.append('motiv_bredd_mm', document.getElementById('motiv_bredd_mm').value);
    formData.append('motiv_hojd_mm', document.getElementById('motiv_hojd_mm').value);
    formData.append('pp_vanster_mm', document.getElementById('pp_vanster_mm').value);
    formData.append('pp_hoger_mm', document.getElementById('pp_hoger_mm').value);
    formData.append('pp_topp_mm', document.getElementById('pp_topp_mm').value);
    formData.append('pp_botten_mm', document.getElementById('pp_botten_mm').value);
    formData.append('calculation_method', document.getElementById('calculation_method').value);
    formData.append('simple_price_per_meter', document.getElementById('simple_price_per_meter').value);
    formData.append('notes', document.getElementById('notes').value || '');
    
    // Add items as JSON
    const itemsData = items.map(item => ({
        type: item.type,
        item_id: item.item_id,
        item_name: item.item_name,
        item_sku: item.item_sku,
        quantity: item.quantity,
        unit_price: item.unit_price,
        metadata: item.metadata
    }));
    formData.append('itemsData', JSON.stringify(itemsData));
    
    // Add template options
    if (document.getElementById('saveAsTemplate').checked) {
        formData.append('saveAsTemplate', 'on');
        formData.append('templateName', document.getElementById('templateName').value);
    }
    
    // Add photos
    beforePhotos.forEach((file) => {
        formData.append('beforeImages', file);
    });
    afterPhotos.forEach((file) => {
        formData.append('afterImages', file);
    });
    
    // Submit via fetch for FormData support
    fetch(e.target.action, {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            window.location.href = response.url;
        } else {
            alert('Ett fel uppstod vid sparandet. F√∂rs√∂k igen.');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('Ett fel uppstod vid sparandet. F√∂rs√∂k igen.');
    });
}

async function loadTemplate() {
    const templateId = document.getElementById('templateSelect').value;
    if (!templateId) {
        alert('V√§lj en mall f√∂rst');
        return;
    }
    
    try {
        // H√§mta mall-data fr√•n EJS-rendererad data
        const allTemplates = <%- JSON.stringify(templates || []) %>;
        const template = allTemplates.find(t => t.id == templateId);
        
        if (!template) {
            alert('Mallen hittades inte');
            return;
        }
        
        // Parse items fr√•n JSON string
        const templateItems = typeof template.items === 'string' ? JSON.parse(template.items) : template.items;
        
        // Load template items
        items = (templateItems || []).map((item, index) => ({
            id: itemIdCounter++,
            category: item.type === 'labor' ? 'service' : 'article',
            type: item.type,
            item_id: item.item_id,
            item_name: item.item_name,
            item_sku: item.item_sku,
            quantity: item.quantity || 0,
            unit_price: item.unit_price || 0,
            metadata: item.metadata || {}
        }));
        
        // Load default PP edges if available
        if (template.default_passepartout_edges) {
            const edges = typeof template.default_passepartout_edges === 'string' ? JSON.parse(template.default_passepartout_edges) : template.default_passepartout_edges;
            if (edges) {
                document.getElementById('pp_vanster_mm').value = edges.left || 0;
                document.getElementById('pp_hoger_mm').value = edges.right || 0;
                document.getElementById('pp_topp_mm').value = edges.top || 0;
                document.getElementById('pp_botten_mm').value = edges.bottom || 0;
            }
        }
        
        renderItems();
        calculatePrice();
    } catch (error) {
        console.error('Failed to load template:', error);
        alert('Kunde inte ladda mall: ' + error.message);
    }
}
</script>
